<?php

declare(strict_types=1);

namespace RD\Autotranslate\Controller;

use TYPO3\CMS\Core\Database\ConnectionPool;
use TYPO3\CMS\Core\Utility\GeneralUtility;
use TYPO3\CMS\Core\Site\SiteFinder;
use TYPO3\CMS\Core\Cache\CacheManager;
use Psr\Http\Message\ResponseInterface;

class AutotranslateController extends \TYPO3\CMS\Extbase\Mvc\Controller\ActionController
{
    /**
     * Main action: Displays content and handles translation trigger
     */
    public function indexAction(): ResponseInterface
    {
        $queryParams = $this->request->getQueryParams();
        $pageUid = (int)($queryParams['id'] ?? 0);
        $doTranslate = (int)($queryParams['doTranslate'] ?? 0);
        $finish = (int)($queryParams['finish'] ?? 0);

        if ($pageUid > 0) {
            $siteFinder = GeneralUtility::makeInstance(SiteFinder::class);
            $site = $siteFinder->getSiteByPageId($pageUid);
            $allLanguages = $site->getLanguages();

            if ($doTranslate === 1) {
                $this->runTranslateProcess($pageUid);
                return $this->redirect('index', null, null, ['id' => $pageUid, 'finish' => 1]);
            }

            $connectionPool = GeneralUtility::makeInstance(ConnectionPool::class);
            
            // Fetch English records
            $contentElements = $connectionPool->getQueryBuilderForTable('tt_content')
                ->select('uid', 'header', 'CType')
                ->from('tt_content')
                ->where('pid=' . $pageUid, 'sys_language_uid=0', 'deleted=0')
                ->orderBy('sorting', 'ASC')
                ->executeQuery()->fetchAllAssociative();

            // Find every table that has records for this PID (The Folder Functionality)
            $detectedTables = [];
            $allTables = $connectionPool->getConnectionForTable('pages')->createSchemaManager()->listTableNames();
            foreach ($allTables as $tName) {
                if (str_starts_with($tName, 'sys_') || str_starts_with($tName, 'be_') || str_starts_with($tName, 'cf_')) continue;
                try {
                    $qb = $connectionPool->getQueryBuilderForTable($tName);
                    $sm = $connectionPool->getConnectionForTable($tName)->createSchemaManager();
                    if (!$sm->tablesExist([$tName])) continue;
                    $cols = $sm->listTableColumns($tName);
                    if (!isset($cols['pid'])) continue;

                    $c = (int)$qb->count('uid')->from($tName)->where('pid=' . $pageUid, 'sys_language_uid=0', 'deleted=0')->executeQuery()->fetchOne();
                    if ($c > 0) $detectedTables[] = ['tableName' => $tName, 'count' => $c];
                } catch (\Exception $e) { continue; }
            }

            $this->view->assignMultiple([
                'pageUid' => $pageUid,
                'languages' => $allLanguages,
                'contentElements' => $contentElements,
                'detectedTables' => $detectedTables,
                'translationDone' => ($finish === 1) 
            ]);
        }
        
        return $this->htmlResponse();
    }

    /**
     * Entry point: Scans ALL tables found in the folder and translates them
     */
    private function runTranslateProcess(int $pageUid): void
    {
        $site = GeneralUtility::makeInstance(SiteFinder::class)->getSiteByPageId($pageUid);
        $languages = $site->getLanguages();
        $connectionPool = GeneralUtility::makeInstance(ConnectionPool::class);

        // Get all tables in the DB
        $allTableNames = $connectionPool->getConnectionForTable('pages')->createSchemaManager()->listTableNames();

        foreach ($languages as $language) {
            $targetLangId = $language->getLanguageId();
            if ($targetLangId === 0) continue; 
            $iso = substr((string)$language->getLocale(), 0, 2); 

            foreach ($allTableNames as $tableName) {
                if (str_starts_with($tableName, 'sys_') || str_starts_with($tableName, 'be_') || str_starts_with($tableName, 'cf_')) continue;

                $sm = $connectionPool->getConnectionForTable($tableName)->createSchemaManager();
                $columns = $sm->listTableColumns($tableName);

                // Only process tables with PID and Language support
                if (!isset($columns['pid']) || !isset($columns['sys_language_uid'])) continue;

                $sourceRecords = $connectionPool->getQueryBuilderForTable($tableName)
                    ->select('*')->from($tableName)
                    ->where('pid=' . $pageUid, 'sys_language_uid=0', 'deleted=0')
                    ->executeQuery()->fetchAllAssociative();

                foreach ($sourceRecords as $record) {
                    $this->translateSingleRecord($tableName, $record, $targetLangId, $iso, $columns);
                }
            }
        }
        GeneralUtility::makeInstance(CacheManager::class)->flushCachesInGroupByTag('pages', 'pageId_' . $pageUid);
    }

    private function translateSingleRecord(string $tableName, array $record, int $targetLangId, string $iso, array $columns): void
    {
        $connectionPool = GeneralUtility::makeInstance(ConnectionPool::class);
        $parentField = isset($columns['l10n_parent']) ? 'l10n_parent' : (isset($columns['l18n_parent']) ? 'l18n_parent' : '');

        // ðŸ›‘ ANTI-REPEAT CHECK: Check if translation already exists
        if ($parentField !== '') {
            $exists = $connectionPool->getQueryBuilderForTable($tableName)
                ->select('uid')->from($tableName)
                ->where($parentField . '=' . (int)$record['uid'], 'sys_language_uid=' . (int)$targetLangId, 'deleted=0')
                ->executeQuery()->fetchOne();
            if ($exists) return; // Skip if already translated
        }

        $insertData = $record;
        unset($insertData['uid']); 
        $insertData['sys_language_uid'] = $targetLangId;
        $insertData['tstamp'] = $insertData['crdate'] = time();
        if ($parentField !== '') $insertData[$parentField] = $record['uid'];

        foreach ($insertData as $fieldName => $value) {
            if ($this->isTranslatableText($fieldName, $value)) {
                $insertData[$fieldName] = $this->googleTranslate((string)$value, $iso);
            }
        }

        $conn = $connectionPool->getConnectionForTable($tableName);
        $conn->insert($tableName, $insertData);
        $newUid = (int)$conn->lastInsertId();

        // Recursively handle Children (Mask/IRRE) and Images
        $this->scanAndTranslateChildren($tableName, (int)$record['uid'], $newUid, $targetLangId, $iso);
        $this->mirrorFileReferences((int)$record['uid'], $newUid, $targetLangId, $tableName);
    }

    // --- Keep your existing helper methods below exactly as they were ---

    private function scanAndTranslateChildren(string $parentTable, int $oldParentUid, int $newParentUid, int $targetLangId, string $iso): void
    {
        $connectionPool = GeneralUtility::makeInstance(ConnectionPool::class);
        $parentRecord = $connectionPool->getQueryBuilderForTable($parentTable)
            ->select('*')->from($parentTable)->where('uid=' . $oldParentUid)->executeQuery()->fetchAssociative();

        if (!$parentRecord) return;

        foreach ($parentRecord as $fieldName => $value) {
            if (str_starts_with((string)$fieldName, 'tx_') && is_numeric($value) && (int)$value > 0) {
                $childTable = (string)$fieldName; 
                try {
                    $conn = $connectionPool->getConnectionForTable($childTable);
                    $schemaManager = $conn->createSchemaManager();
                    if (!$schemaManager->tablesExist([$childTable])) continue;

                    $columns = $schemaManager->listTableColumns($childTable);
                    $foreignKey = isset($columns['parentid']) ? 'parentid' : 
                                 (isset($columns['tt_content']) ? 'tt_content' : 
                                 (isset($columns[$parentTable]) ? $parentTable : ''));
                                 
                    if ($foreignKey === '') continue;

                    $queryBuilder = $connectionPool->getQueryBuilderForTable($childTable);
                    $children = $queryBuilder->select('*')->from($childTable)
                        ->where($queryBuilder->expr()->eq($foreignKey, $queryBuilder->createNamedParameter($oldParentUid)))
                        ->andWhere('deleted=0', 'sys_language_uid=0')
                        ->executeQuery()->fetchAllAssociative();

                    foreach ($children as $child) {
                        $oldChildUid = (int)$child['uid'];
                        $childData = $child;
                        unset($childData['uid']);
                        $childData[$foreignKey] = $newParentUid;
                        $childData['tstamp'] = $childData['crdate'] = time();
                        if (isset($columns['sys_language_uid'])) $childData['sys_language_uid'] = $targetLangId;
                        
                        $langParentField = isset($columns['l10n_parent']) ? 'l10n_parent' : (isset($columns['l18n_parent']) ? 'l18n_parent' : '');
                        if ($langParentField !== '') $childData[$langParentField] = $oldChildUid;

                        foreach ($childData as $fName => $fValue) {
                            if ($this->isTranslatableText($fName, $fValue)) {
                                $childData[$fName] = $this->googleTranslate((string)$fValue, $iso);
                            }
                        }
                        $conn->insert($childTable, $childData);
                        $newChildUid = (int)$conn->lastInsertId();
                        $this->mirrorFileReferences($oldChildUid, $newChildUid, $targetLangId, $childTable);
                        $this->scanAndTranslateChildren($childTable, $oldChildUid, $newChildUid, $targetLangId, $iso);
                    }
                } catch (\Exception $e) { continue; }
            }
        }
    }

    private function mirrorFileReferences(int $oldUid, int $newUid, int $targetLangId, string $tableName): void
    {
        $connectionPool = GeneralUtility::makeInstance(ConnectionPool::class);
        $refConn = $connectionPool->getConnectionForTable('sys_file_reference');
        $fileReferences = $connectionPool->getQueryBuilderForTable('sys_file_reference')
            ->select('*')->from('sys_file_reference')
            ->where('uid_foreign=' . (int)$oldUid, 'tablenames=' . $refConn->quote($tableName), 'deleted=0')
            ->executeQuery()->fetchAllAssociative();

        foreach ($fileReferences as $ref) {
            $refData = $ref;
            unset($refData['uid']);
            $refData['sys_language_uid'] = $targetLangId;
            $refData['uid_foreign'] = $newUid;
            $refData['tstamp'] = $refData['crdate'] = time();
            $refConn->insert('sys_file_reference', $refData);
        }
    }

    private function isTranslatableText(string $fieldName, $value): bool
    {
        $technicalFields = ['CType', 'list_type', 'layout', 'colPos', 'sys_language_uid', 'l18n_parent', 'l10n_source', 'parentid', 'parenttable', 'uid', 'pid', 'tstamp', 'crdate', 'hidden', 'deleted', 'sorting', 'imageorient', 'header_layout', 'frame_class'];
        return (is_string($value) && !empty(trim($value)) && !is_numeric($value) && strlen($value) > 1 && !in_array($fieldName, $technicalFields, true) && !str_starts_with($value, 'EXT:'));
    }

    private function googleTranslate(string $text, string $target): string
    {
        if (empty(trim(strip_tags($text)))) return $text;
        try {
            $url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" . $target . "&dt=t&q=" . urlencode($text);
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_TIMEOUT, 10);
            $output = curl_exec($ch);
            curl_close($ch);
            $res = json_decode((string)$output, true);
            $fullTranslation = "";
            if (isset($res[0]) && is_array($res[0])) {
                foreach ($res[0] as $segment) { $fullTranslation .= $segment[0] ?? ''; }
            }
            return !empty($fullTranslation) ? $fullTranslation : $text;
        } catch (\Exception $e) { return $text; }
    }
}